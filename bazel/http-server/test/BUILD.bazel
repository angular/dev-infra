load("@aspect_rules_js//js:defs.bzl", "js_test")
load("@aspect_rules_ts//ts:defs.bzl", "ts_project")
load("//bazel/http-server:index.bzl", "http_server")

ts_project(
    name = "app_lib",
    testonly = True,
    srcs = ["main.ts"],
    tsconfig = "tsconfig.app.json",
)

http_server(
    name = "server",
    testonly = True,
    srcs = ["index.html"],
    environment_variables = ["GOOGLE_MAPS_API_KEY"],
    deps = [":app_lib"],
)

ts_project(
    name = "test_lib",
    testonly = True,
    srcs = ["server-test.ts"],
    declaration = True,
    tsconfig = "//bazel:tsconfig",
    deps = [
        "//bazel:node_modules/@types/node",
        "//bazel:node_modules/@types/selenium-webdriver",
        "//bazel:node_modules/@types/wait-on",
        "//bazel:node_modules/selenium-webdriver",
        "//bazel:node_modules/wait-on",
    ],
)

js_test(
    name = "test",
    # Pass the chromium and chromedriver binaries as arguments to the test.
    # These variables are made available by the toolchain alias.
    args = [
        "$(CHROME-HEADLESS-SHELL)",
        "$(CHROMEDRIVER)",
    ],
    data = [
        ":server",
        ":test_lib",
        "@rules_browsers//browsers/chromium",
    ],
    entry_point = ":server-test.js",
    toolchains = ["@rules_browsers//browsers/chromium:toolchain_alias"],
)
