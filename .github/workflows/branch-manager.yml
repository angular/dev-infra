name: Branch Manager

on: [workflow_dispatch]

# Declare default permissions as read only.
permissions: read-all

jobs:
  get_merge_ready_prs:
    runs-on: ubuntu-latest
    outputs: 
      data: ${{ steps.branch_manager.outputs.data }}
    steps:
      - uses: actions/checkout@2541b1294d2704b0964813337f33b291d3f8596b # tag=v3.0.2
      - uses: actions/setup-node@v3
        with:
          node-version: '16'
          cache: 'yarn'
      - name: install deps
        run: yarn install
      - uses: ./github-actions/branch-manager
        env:
          NODE_OPTIONS: '--loader ts-node/esm'
        id: branch_manager
        with:
          angular-robot-key: ${{ secrets.ANGULAR_ROBOT_PRIVATE_KEY }}

  check_mergability_of_pr:
    runs-on: ubuntu-latest
    needs: get_merge_ready_prs
    strategy:
      matrix:
        pr: ${{ fromJSON(needs.get_merge_ready_prs.outputs.data) }}
    steps:
      - uses: actions/checkout@2541b1294d2704b0964813337f33b291d3f8596b # tag=v3.0.2
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v3
        with:
          node-version: '16'
          cache: 'yarn'
      - name: install deps
        run: yarn install
      - uses: ./github-actions/branch-manager
        env:
          NODE_OPTIONS: '--loader ts-node/esm'
        with:
          angular-robot-key: ${{ secrets.ANGULAR_ROBOT_PRIVATE_KEY }}
          pr: ${{ matrix.pr }}
